<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plumbing Field Log ‚Äî Durrant Slate</title>
  <!-- Add a manifest for PWA support -->
  <meta name="theme-color" content="#0f172a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <!-- Load localForage for IndexedDB storage -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js" integrity="sha512-G0dzkjoWTxofNcV+oJ5BX0tK6jq4RqMjece9D5PvQGjVDFL2Sd6zAHLgpD4+dWZGaWavWXIgiMlXvvp8Ox9KYg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- Load signature_pad for capturing signatures -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.0/dist/signature_pad.umd.min.js" integrity="sha384-OTluVJkMsu21b6rRctSh/ZC7AL1X+1GzlSIwHtdPPKP+k9n6Xtp2cN46FRNrdbr7" crossorigin="anonymous"></script>
  <style>
    :root{
      /* Dark theme variables */
      --bg: #0d1117;
      --bg-elev: #121826;
      --panel: #161d2b;
      --muted: #94a3b8;
      --text: #e6edf3;
      --accent: #1e3a8a;
      --accent-2: #3b82f6;
      --ok: #22c55e;
      --warn: #f59e0b;
      --bad: #ef4444;
      --border: #283246;
      --chip: #0a244d;
      --shadow: rgba(0,0,0,.35);
      --radius: 16px;
      --focus: 0 0 0 3px rgba(30,58,138,.5);
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    [data-theme="light"] {
      /* Light theme overrides */
      --bg: #f8fafc;
      --bg-elev: #ffffff;
      --panel: #f1f5f9;
      --muted: #475569;
      --text: #1e293b;
      --accent: #1e40af;
      --accent-2: #2563eb;
      --border: #cbd5e1;
      --chip: #e2e8f0;
      --shadow: rgba(0,0,0,.1);
    }

    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:var(--font);}    
    a{color:var(--accent)}
    .wrap{max-width:980px;margin:0 auto;padding:16px}

    header{
      position:sticky;top:0;z-index:5;background:linear-gradient(180deg, rgba(11,18,32,.96), rgba(11,18,32,.9));
      backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--border);
    }
    .bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 16px}
    .title{display:flex;gap:10px;align-items:baseline}
    .title h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.2px}

    .actions{display:flex;gap:8px;flex-wrap:wrap}
    button{appearance:none;background:var(--accent);color:white;border:none;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer;box-shadow:0 6px 20px var(--shadow);transition:transform .06s ease, filter .2s ease}
    button.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    button.ghost{background:transparent;color:var(--muted)}
    button:active{transform:translateY(1px)}
    button:focus{outline:none;box-shadow:var(--focus)}

    nav.tabs{display:flex;gap:10px;border-bottom:1px solid var(--border);padding:8px 4px;margin-top:6px}
    nav.tabs button{background:transparent;color:var(--muted);border:1px solid transparent;border-radius:10px;padding:8px 12px}
    nav.tabs button.active{color:var(--text);border-color:var(--border);background:var(--panel)}

    .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:0 10px 30px var(--shadow);padding:14px}
    .grid{display:grid;gap:12px}

    @media(min-width:760px){
      .two{grid-template-columns:1fr 1fr}
      .three{grid-template-columns:repeat(3,1fr)}
    }

    label{display:block;font-size:12px;color:var(--muted);margin:6px 2px}
    input[type="text"], input[type="number"], input[type="date"], input[type="time"], textarea, select{
      width:100%;background:#0e1624;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:12px 12px;
    }
    textarea{min-height:96px;resize:vertical}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{display:inline-flex;gap:6px;align-items:center;background:#0e1624;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted);font-size:12px}
    .kpi{display:flex;gap:8px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px;display:inline-block}

    .list-header{display:flex;gap:10px;align-items:center;justify-content:space-between;margin:8px 0}
    .list{display:grid;gap:10px}
    .item{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px}
    .item h3{margin:0 0 6px 0;font-size:16px}
    .muted{color:var(--muted)}
    .chips{display:flex;gap:6px;flex-wrap:wrap}

    .thumb{width:88px;height:66px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .thumb-wrap{display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}

    .hr{height:1px;background:var(--border);margin:10px 0}
    .hidden{display:none}

    /* Light theme input colours override */
    [data-theme="light"] input[type="text"], [data-theme="light"] input[type="number"],
    [data-theme="light"] input[type="date"], [data-theme="light"] input[type="time"], [data-theme="light"] textarea, [data-theme="light"] select {
      background:#fff;
    }

    /* Print styles for single-entry print view */
    @media print{
      header, nav, .actions, #entries, #importer, #settings { display:none !important }
      body{background:white;color:black}
      .card{box-shadow:none;border-color:#ddd}
    }
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="title">
        <h1>Plumbing Field Log</h1>
      </div>
      <div class="actions">
        <button id="btnExportJSON" title="Export all entries as JSON" type="button">Export JSON</button>
        <button id="btnExportCSV" class="secondary" title="Export all entries as CSV" type="button">Export CSV</button>
        <button id="btnImport" class="secondary" title="Import from a JSON backup" type="button">Import</button>
        <button id="btnSettings" class="ghost" title="Preferences" type="button">Settings</button>
        <button id="toggleTheme" class="secondary" title="Toggle Light/Dark Mode" type="button">üåì</button>
        <!-- Sync actions use the File System Access API to save and load a log file. -->
        <button id="btnSaveToFile" class="secondary" title="Save entries to a JSON file" type="button">Save to File</button>
        <button id="btnLoadFromFile" class="secondary" title="Load entries from a JSON file" type="button">Load from File</button>
      </div>
    </div>
    <nav class="tabs wrap">
      <button class="active" data-tab="form" type="button">New / Edit</button>
      <button data-tab="entries" type="button">Entries</button>
    </nav>
  </header>

  <main class="wrap">
    <!-- FORM CARD -->
    <section id="form" class="card grid">
      <form id="entryForm" class="grid two">
        <input type="hidden" id="entryId" />
        <div>
          <label for="date">Date</label>
          <input type="date" id="date" required />
        </div>
        <div>
          <label for="time">Time</label>
          <input type="time" id="time" required />
        </div>

        <div>
          <label for="job">Job Site (name / lot)</label>
          <input type="text" id="job" placeholder="e.g., Symphony Homes ‚Ä¢ Lot 12" required />
        </div>
        <div>
          <label for="location">Location (address or lat,lng)</label>
          <div class="row" style="gap:8px">
            <input type="text" id="location" placeholder="123 W Example Rd, Saratoga Springs" />
            <button type="button" id="btnGPS" class="secondary" title="Use GPS">üìç</button>
            <button type="button" id="btnMaps" class="secondary" title="Open in Maps">üó∫Ô∏è</button>
          </div>
          <div id="coords" class="muted" style="margin-top:4px"></div>
        </div>

        <div>
          <label for="gc">GC Company</label>
          <input type="text" id="gc" placeholder="e.g., Rainey Homes / Symphony Homes" />
        </div>
        <div>
          <label for="super">Superintendent</label>
          <input type="text" id="super" placeholder="Name" />
        </div>

        <div class="hr two" style="grid-column:1 / -1"></div>

        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Water Lines Test</h3>
          <div class="grid two">
            <div>
              <label for="waterTested">Tested?</label>
              <select id="waterTested">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div>
              <label for="waterPass">Pass/Fail</label>
              <select id="waterPass">
                <option value="N/A">N/A</option>
                <option value="Pass">Pass</option>
                <option value="Fail">Fail</option>
              </select>
            </div>
            <div>
              <label for="waterPSI">PSI</label>
              <input type="number" id="waterPSI" placeholder="e.g., 100" inputmode="decimal" />
            </div>
            <div>
              <label for="waterMinutes">Duration (min)</label>
              <input type="number" id="waterMinutes" placeholder="e.g., 15" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Drainage Test</h3>
          <div class="grid two">
            <div>
              <label for="drainTested">Tested?</label>
              <select id="drainTested">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div>
              <label for="drainPass">Pass/Fail</label>
              <select id="drainPass">
                <option value="N/A">N/A</option>
                <option value="Pass">Pass</option>
                <option value="Fail">Fail</option>
              </select>
            </div>
            <div>
              <label for="drainHead">Head (ft/in or inches)</label>
              <input type="text" id="drainHead" placeholder="e.g., 10' head or 120 in" />
            </div>
            <div>
              <label for="drainMinutes">Duration (min)</label>
              <input type="number" id="drainMinutes" placeholder="e.g., 15" inputmode="decimal" />
            </div>
          </div>
        </div>

        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Inspection / Test Tag</h3>
          <div class="grid two">
            <div>
              <label for="testPulled">Test Pulled?</label>
              <select id="testPulled">
                <option value="No">No</option>
                <option value="Yes">Yes</option>
              </select>
            </div>
            <div>
              <label for="inspector">Inspector / City</label>
              <input type="text" id="inspector" placeholder="City & inspector (if any)" />
            </div>
            <div>
              <label for="permit">Permit / Tag #</label>
              <input type="text" id="permit" placeholder="Optional" />
            </div>
            <div>
              <label for="nextSteps">Next Steps</label>
              <input type="text" id="nextSteps" placeholder="e.g., Re-test tomorrow, fix leak @ lav" />
            </div>
          </div>
        </div>

        <!-- Status and Materials -->
        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Status & Materials</h3>
          <div class="grid two">
            <div style="grid-column:1 / -1">
              <label for="completed">Completed Today</label>
              <textarea id="completed" placeholder="Rough-in master bath; set tub drain; pressure test"></textarea>
            </div>
            <div style="grid-column:1 / -1">
              <label for="attention">Needs Attention</label>
              <textarea id="attention" placeholder="Leak at 2F lav cold stub; order 3/4&quot; PEX tees"></textarea>
            </div>

            <div style="grid-column:1 / -1">
              <label>Materials Used</label>
              <div id="materials"></div>
              <div class="row" style="margin-top:6px">
                <button type="button" id="btnAddMat" class="secondary">+ Add Material</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Photos -->
        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Photos & Descriptions</h3>
          <div class="row">
            <input type="file" id="photoInput" accept="image/*" multiple />
          </div>
          <div id="photoList" class="thumb-wrap" style="margin-top:8px"></div>
        </div>

        <!-- Signature -->
        <div class="card" style="background:var(--bg-elev)">
          <h3 style="margin:0 0 8px 0">Signature</h3>
          <p class="muted">Use your finger or mouse to sign below. A signature can be used to sign off work.</p>
          <canvas id="signaturePad" width="320" height="160" style="border:1px solid var(--border);border-radius:6px;background:var(--bg);touch-action:none"></canvas>
          <div class="row" style="margin-top:6px">
            <button type="button" id="btnClearSignature" class="secondary">Clear Signature</button>
          </div>
        </div>

        <div style="grid-column:1 / -1">
          <label for="notes">General Notes</label>
          <textarea id="notes" placeholder="What you did, materials, issues, who you talked to, punch items..."></textarea>
        </div>

        <div class="row" style="grid-column:1 / -1;justify-content:space-between;margin-top:4px">
          <div class="row">
            <button type="submit">Save Entry</button>
            <button type="button" id="btnReset" class="secondary">Clear</button>
          </div>
          <div class="row">
            <button type="button" id="btnPrint" class="secondary" title="Print current entry">Print</button>
            <button type="button" id="btnDuplicate" class="secondary" title="Duplicate current values into a new entry">Duplicate</button>
          </div>
        </div>
      </form>
    </section>

    <!-- ENTRIES -->
    <section id="entries" class="hidden">
      <div class="list-header">
        <div class="row" style="gap:8px">
          <input id="search" type="text" placeholder="Search job, notes, GC, super..." style="min-width:250px" />
          <select id="filterPass">
            <option value="">All</option>
            <option value="Pass">Water: Pass</option>
            <option value="Fail">Water: Fail</option>
            <option value="DPass">Drain: Pass</option>
            <option value="DFail">Drain: Fail</option>
          </select>
        </div>
        <div class="row">
          <select id="sortBy">
            <option value="dateDesc">Newest first</option>
            <option value="dateAsc">Oldest first</option>
            <option value="jobAZ">Job A‚ÜíZ</option>
            <option value="jobZA">Job Z‚ÜíA</option>
          </select>
        </div>
      </div>
      <div id="list" class="list"></div>
    </section>

    <!-- IMPORTER -->
    <section id="importer" class="hidden card">
      <h3 style="margin-top:0">Import JSON Backup</h3>
      <p class="muted">Choose a previously exported JSON file. Entries will be merged as new copies.</p>
      <input type="file" id="fileInput" accept="application/json" />
    </section>

    <!-- SETTINGS -->
    <section id="settings" class="hidden card grid two">
      <div>
        <label for="defGC">Default GC Company</label>
        <input id="defGC" type="text" placeholder="Optional" />
      </div>
      <div>
        <label for="defPSI">Default Water Test PSI</label>
        <input id="defPSI" type="number" placeholder="e.g., 100" />
      </div>
      <div>
        <label for="defCity">Default City</label>
        <input id="defCity" type="text" placeholder="Optional" />
      </div>
      <div>
        <label for "defSuper">Default Superintendent</label>
        <input id="defSuper" type="text" placeholder="Optional" />
      </div>
      <div>
        <label for="geoProvider">Geocoding Provider</label>
        <select id="geoProvider">
          <option value="nominatim">OpenStreetMap (free)</option>
          <option value="locationiq">LocationIQ (API key)</option>
          <option value="mapbox">Mapbox (token)</option>
        </select>
      </div>
      <div>
        <label for="geoApiKey">API Key / Token</label>
        <input id="geoApiKey" type="text" placeholder="Leave empty for OpenStreetMap" />
      </div>
      <div>
        <label for="contactEmail">Contact Email (for OSM)</label>
        <input id="contactEmail" type="email" placeholder="Optional, improves reliability" />
      </div>
      <div>
        <label for="addrFormat">Address Format</label>
        <select id="addrFormat">
          <option value="full">Full</option>
          <option value="short">Short</option>
        </select>
      </div>
      <div style="grid-column:1 / -1" class="row">
        <button id="btnSaveSettings" type="button">Save Settings</button>
        <button id="btnClearAll" class="secondary" type="button" title="Delete ALL entries (cannot be undone)">Clear ALL Entries</button>
      </div>
    </section>
  </main>

  <script>
    // -------------------------------------------
    // LocalForage configuration for IndexedDB
    // Using IndexedDB via localForage to store larger datasets asynchronously.
    localforage.config({
      name: 'plumbLog',
      version: 1.0,
      storeName: 'entriesStore'
    });

    const SETTINGS_KEY = 'settings';

    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);

    const todayStr = () => new Date().toISOString().slice(0,10);
    const timeStr = () => new Date().toTimeString().slice(0,5);

    async function loadEntries(){
      const arr = await localforage.getItem('entries');
      return Array.isArray(arr) ? arr : [];
    }
    async function saveEntries(arr){
      try { await localforage.setItem('entries', arr); }
      catch(err){ alert('Save failed (likely photo storage is full). Try removing some photos or exporting & clearing.'); }
    }
    async function loadSettings(){
      const s = await localforage.getItem(SETTINGS_KEY);
      return s || {};
    }
    async function saveSettings(obj){ await localforage.setItem(SETTINGS_KEY, obj); }

    function uid(){ return (crypto.randomUUID ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2)); }

    const state = { entries: [], settings: {}, formPhotos: [], signature: null };

    // Initialize signature pad
    let signaturePad;

    // Theme toggle
    function toggleTheme(){
      const current = document.documentElement.dataset.theme;
      const newTheme = current === 'light' ? 'dark' : 'light';
      document.documentElement.dataset.theme = newTheme;
      // persist theme in settings
      state.settings.theme = newTheme;
      saveSettings(state.settings);
    }

    // Set theme from settings
    function applyThemeFromSettings(){
      const theme = state.settings.theme || 'dark';
      document.documentElement.dataset.theme = theme;
    }

    // Tab navigation
    $$('nav.tabs button').forEach(b=>{
      b.addEventListener('click', ()=>{
        $$('nav.tabs button').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        ['form','entries','importer','settings'].forEach(id=> $('#'+id).classList.add('hidden'));
        const tab = b.dataset.tab;
        if(tab==='form') $('#form').classList.remove('hidden');
        if(tab==='entries'){ $('#entries').classList.remove('hidden'); renderList(); }
      });
    });

    // Header action routes
    $('#btnImport').addEventListener('click', ()=>{
      $$('nav.tabs button').forEach(x=>x.classList.remove('active'));
      ['form','entries','settings'].forEach(id=> $('#'+id).classList.add('hidden'));
      $('#importer').classList.remove('hidden');
    });
    $('#btnSettings').addEventListener('click', ()=>{
      $$('nav.tabs button').forEach(x=>x.classList.remove('active'));
      ['form','entries','importer'].forEach(id=> $('#'+id).classList.add('hidden'));
      $('#settings').classList.remove('hidden');
      // preload settings into fields
      $('#defGC').value = state.settings.defGC || '';
      $('#defPSI').value = state.settings.defPSI || '';
      $('#defCity').value = state.settings.defCity || '';
      $('#defSuper').value = state.settings.defSuper || '';
      $('#geoProvider').value = state.settings.geoProvider || 'nominatim';
      $('#geoApiKey').value = state.settings.geoApiKey || '';
      $('#contactEmail').value = state.settings.contactEmail || '';
      $('#addrFormat').value = state.settings.addrFormat || 'full';
    });

    // Theme toggle button
    $('#toggleTheme').addEventListener('click', toggleTheme);

    // Form helpers
    function resetForm(preset={}){
      $('#entryId').value = preset.id || '';
      $('#date').value = preset.date || todayStr();
      $('#time').value = preset.time || timeStr();
      $('#job').value = preset.job || '';
      $('#location').value = preset.location || '';
      const coordsObj = preset.coords || null;
      $('#coords').textContent = coordsObj ? `GPS: ${coordsObj.lat.toFixed(6)}, ${coordsObj.lng.toFixed(6)}` : '';
      $('#coords').dataset.coords = coordsObj ? JSON.stringify(coordsObj) : '';
      $('#gc').value = preset.gc || state.settings.defGC || '';
      $('#super').value = preset.super || state.settings.defSuper || '';
      $('#waterTested').value = preset.waterTested || 'No';
      $('#waterPass').value = preset.waterPass || 'N/A';
      $('#waterPSI').value = preset.waterPSI ?? (state.settings.defPSI || '');
      $('#waterMinutes').value = preset.waterMinutes || '';
      $('#drainTested').value = preset.drainTested || 'No';
      $('#drainPass').value = preset.drainPass || 'N/A';
      $('#drainHead').value = preset.drainHead || '';
      $('#drainMinutes').value = preset.drainMinutes || '';
      $('#testPulled').value = preset.testPulled || 'No';
      $('#inspector').value = preset.inspector || (state.settings.defCity ? `${state.settings.defCity}` : '');
      $('#permit').value = preset.permit || '';
      $('#nextSteps').value = preset.nextSteps || '';
      $('#completed').value = preset.completed || '';
      $('#attention').value = preset.attention || '';
      setMaterials(preset.materials || []);
      state.formPhotos = Array.isArray(preset.photos) ? preset.photos : [];
      renderPhotos();
      state.signature = preset.signature || null;
      // clear signature pad
      if(signaturePad){
        signaturePad.clear();
        // If there is a stored signature, draw it using signature_pad API
        if(state.signature){
          try{ signaturePad.fromDataURL(state.signature); }catch(e){ /* ignore invalid signature */ }
        }
      }
      $('#notes').value = preset.notes || '';
    }

    function readForm(){
      return {
        id: $('#entryId').value || uid(),
        date: $('#date').value,
        time: $('#time').value,
        job: $('#job').value.trim(),
        location: $('#location').value.trim(),
        coords: $('#coords').dataset.coords ? JSON.parse($('#coords').dataset.coords) : null,
        gc: $('#gc').value.trim(),
        super: $('#super').value.trim(),
        waterTested: $('#waterTested').value,
        waterPass: $('#waterPass').value,
        waterPSI: $('#waterPSI').value ? Number($('#waterPSI').value) : '',
        waterMinutes: $('#waterMinutes').value ? Number($('#waterMinutes').value) : '',
        drainTested: $('#drainTested').value,
        drainPass: $('#drainPass').value,
        drainHead: $('#drainHead').value.trim(),
        drainMinutes: $('#drainMinutes').value ? Number($('#drainMinutes').value) : '',
        testPulled: $('#testPulled').value,
        inspector: $('#inspector').value.trim(),
        permit: $('#permit').value.trim(),
        nextSteps: $('#nextSteps').value.trim(),
        completed: $('#completed').value.trim(),
        attention: $('#attention').value.trim(),
        materials: getMaterials(),
        photos: state.formPhotos,
        signature: state.signature,
        notes: $('#notes').value.trim(),
        createdAt: $('#entryId').value ? undefined : new Date().toISOString(),
        updatedAt: new Date().toISOString()
      };
    }

    function isSecure(){ return (window.isSecureContext || location.protocol==='https:' || location.hostname==='localhost'); }
    function formatLatLng(lat,lng){ return `${lat.toFixed(6)}, ${lng.toFixed(6)}`; }

    function shortAddrFromOSM(obj){
      const a = obj && obj.address ? obj.address : {};
      const parts = [];
      if(a.road) parts.push(a.house_number ? `${a.house_number} ${a.road}` : a.road);
      const city = a.city || a.town || a.village || a.hamlet;
      if(city) parts.push(city);
      if(a.state) parts.push(a.state);
      return parts.join(', ');
    }

    async function reverseGeocode(lat,lng){
      const provider = (state.settings.geoProvider || 'nominatim');
      const key = state.settings.geoApiKey || '';
      const wantShort = (state.settings.addrFormat || 'full') === 'short';
      try{
        if(provider==='locationiq' && key){
          const url = `https://us1.locationiq.com/v1/reverse?key=${encodeURIComponent(key)}&lat=${lat}&lon=${lng}&format=json&normalizeaddress=1`;
          const r = await fetch(url);
          if(!r.ok) throw new Error('LocationIQ failed');
          const j = await r.json();
          if(wantShort && j.address){
            const parts = [j.address.road, j.address.city || j.address.town || j.address.village, j.address.state].filter(Boolean);
            return parts.join(', ') || j.display_name || formatLatLng(lat,lng);
          }
          return j.display_name || formatLatLng(lat,lng);
        }
        if(provider==='mapbox' && key){
          const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?access_token=${encodeURIComponent(key)}`;
          const r = await fetch(url);
          if(!r.ok) throw new Error('Mapbox failed');
          const j = await r.json();
          const full = j.features && j.features[0] && j.features[0].place_name;
          return full || formatLatLng(lat,lng);
        }
        // Default: Nominatim (OSM)
        const email = state.settings.contactEmail ? `&email=${encodeURIComponent(state.settings.contactEmail)}` : '';
        const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1${email}`;
        const r = await fetch(url, { headers: { 'Accept':'application/json' }});
        if(!r.ok) throw new Error('Nominatim failed');
        const j = await r.json();
        if(wantShort){
          const s = shortAddrFromOSM(j);
          return s || j.display_name || formatLatLng(lat,lng);
        }
        return j.display_name || formatLatLng(lat,lng);
      }catch(err){ console.warn('Reverse geocode failed:', err); return formatLatLng(lat,lng); }
    }

    // GPS capture
    $('#btnGPS').addEventListener('click', ()=>{
      if(!navigator.geolocation){ alert('Geolocation not supported on this device.'); return; }
      if(!isSecure()){
        alert('GPS needs https or localhost. If you opened this as a file, serve it from http://localhost or host it on any https site (e.g., GitHub Pages).');
        return;
      }
      const btn = $('#btnGPS'); btn.disabled = true; btn.textContent = '‚Ä¶';
      navigator.geolocation.getCurrentPosition(async pos=>{
        const { latitude:lat, longitude:lng } = pos.coords;
        const pair = formatLatLng(lat,lng);
        $('#coords').textContent = `GPS: ${pair}`;
        $('#coords').dataset.coords = JSON.stringify({lat, lng, ts: Date.now()});
        try{
          const addr = await reverseGeocode(lat,lng);
          $('#location').value = addr;
        }catch(_){ $('#location').value = pair; }
        btn.textContent = 'üìç'; btn.disabled = false;
      }, err=>{
        alert('GPS error: ' + err.message);
        btn.textContent = 'üìç'; btn.disabled = false;
      }, { enableHighAccuracy:true, timeout:15000, maximumAge:0 });
    });

    // Open in Maps
    document.getElementById('btnMaps').addEventListener('click', ()=>{
      let lat=null, lng=null;
      if($('#coords').dataset.coords){ try { const c = JSON.parse($('#coords').dataset.coords); lat=c.lat; lng=c.lng; } catch(_){} }
      if(lat===null || lng===null){
        const m = ($('#location').value||'').match(/(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)/);
        if(m){ lat=parseFloat(m[1]); lng=parseFloat(m[2]); }
      }
      const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
      let url='';
      if(lat!==null && lng!==null){ const pair = lat + ',' + lng; url = isiOS ? ('https://maps.apple.com/?ll=' + pair) : ('https://www.google.com/maps?q=' + pair); }
      else { const q = encodeURIComponent($('#location').value||''); url = isiOS ? ('https://maps.apple.com/?q=' + q) : ('https://www.google.com/maps/search/?api=1&query=' + q); }
      window.open(url, '_blank');
    });

    // Materials UI
    function escapeHTML(s){ return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
    function matRow(m={ id: uid(), name:'', qty:'', unit:'' }){
      const wrap = document.createElement('div');
      wrap.className = 'row';
      wrap.style.cssText = 'gap:8px; align-items:flex-end; margin:6px 0; flex-wrap:wrap';
      wrap.dataset.id = m.id;
      wrap.innerHTML = `
        <div style="flex:1 1 210px">
          <label>Material</label>
          <input type="text" placeholder="e.g., 1/2&quot; PEX tee" value="${m.name?escapeHTML(m.name):''}">
        </div>
        <div style="width:110px">
          <label>Qty</label>
          <input type="number" inputmode="decimal" value="${m.qty!==undefined?m.qty:''}">
        </div>
        <div style="width:140px">
          <label>Unit</label>
          <input type="text" placeholder="pcs/ft/ea" value="${m.unit?escapeHTML(m.unit):''}">
        </div>
        <button type="button" class="secondary" data-del>Remove</button>
      `;
      wrap.querySelector('[data-del]').addEventListener('click',()=>{ wrap.remove(); });
      return wrap;
    }
    function setMaterials(arr){ const box = $('#materials'); box.innerHTML = ''; (arr && arr.length? arr : [{}]).forEach(m=> box.appendChild(matRow(m))); }
    function getMaterials(){ return Array.from($('#materials').children).map(row=>{
        const [nameEl, qtyEl, unitEl] = row.querySelectorAll('input');
        return { id: row.dataset.id || uid(), name: nameEl.value.trim(), qty: qtyEl.value ? Number(qtyEl.value) : '', unit: unitEl.value.trim() };
      }).filter(m=> m.name || m.qty || m.unit); }
    $('#btnAddMat').addEventListener('click', ()=> $('#materials').appendChild(matRow({})));

    // Photos UI (compressed and stored in memory)
    async function fileToDataURL(file, maxDim=1600, quality=0.75){
      const img = new Image();
      const reader = new FileReader();
      const loaded = new Promise((res,rej)=>{ img.onload=()=>res(); img.onerror=rej; });
      const read = new Promise((res,rej)=>{ reader.onload=()=>{ img.src = reader.result; res(); }; reader.onerror=rej; });
      reader.readAsDataURL(file);
      await read; await loaded;
      const canvas = document.createElement('canvas');
      const { width:w, height:h } = img;
      const scale = Math.min(1, maxDim / Math.max(w,h));
      canvas.width = Math.round(w*scale); canvas.height = Math.round(h*scale);
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      return canvas.toDataURL('image/jpeg', quality);
    }

    function renderPhotos(){
      const box = $('#photoList'); box.innerHTML = '';
      state.formPhotos.forEach(p=>{
        const wrap = document.createElement('div');
        wrap.style.maxWidth = '220px';
        wrap.innerHTML = `
          <img class="thumb" src="${p.dataUrl}" alt="photo" />
          <input type="text" placeholder="description" value="${p.desc?escapeHTML(p.desc):''}" style="width:220px;margin-top:6px">
          <div class="row" style="gap:6px;margin-top:6px">
            <button type="button" class="secondary" data-act="del">Remove</button>
          </div>
        `;
        wrap.querySelector('[data-act="del"]').addEventListener('click', ()=>{
          state.formPhotos = state.formPhotos.filter(x=> x.id!==p.id); renderPhotos();
        });
        wrap.querySelector('input').addEventListener('input', (e)=>{ p.desc = e.target.value; });
        box.appendChild(wrap);
      });
    }

    $('#photoInput').addEventListener('change', async (e)=>{
      const files = Array.from(e.target.files || []);
      for(const f of files){
        try{
          const dataUrl = await fileToDataURL(f);
          state.formPhotos.push({ id: uid(), name: f.name, dataUrl, desc: '' });
        }catch(err){ alert('Photo failed: ' + err.message); }
      }
      renderPhotos();
      e.target.value='';
      toast('Photos added');
    });

    // Signature Pad setup
    function initSignature(){
      const canvas = document.getElementById('signaturePad');
      signaturePad = new SignaturePad(canvas, { backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--bg') });
      $('#btnClearSignature').addEventListener('click', ()=>{
        signaturePad.clear();
        state.signature = null;
      });
      // Save drawn signature to state
      signaturePad.onEnd = () => {
        if(!signaturePad.isEmpty()){ state.signature = signaturePad.toDataURL('image/png'); }
      };
    }

    // Save
    $('#entryForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const data = readForm();
      if(!data.date || !data.time || !data.job){ alert('Date, time, and job site are required.'); return; }
      const idx = state.entries.findIndex(x=> x.id === data.id);
      if(idx>=0){ state.entries[idx] = { ...state.entries[idx], ...data }; }
      else { state.entries.unshift(data); }
      await saveEntries(state.entries);
      resetForm({});
      toast('Saved.');
    });

    // Clear
    $('#btnReset').addEventListener('click', ()=> resetForm({}));

    // Duplicate
    $('#btnDuplicate').addEventListener('click', async ()=>{
      const d = readForm();
      d.id = uid();
      d.date = todayStr();
      d.time = timeStr();
      d.createdAt = new Date().toISOString();
      d.updatedAt = d.createdAt;
      state.entries.unshift(d);
      await saveEntries(state.entries);
      resetForm(d);
      toast('Duplicated as a new entry.');
    });

    // Print
    $('#btnPrint').addEventListener('click', ()=> window.print());

    // Status dot helper
    function statusDot(val){ let c = '#475569'; if(val==='Pass') c = 'var(--ok)'; if(val==='Fail') c = 'var(--bad)'; return `<span class="dot" style="background:${c}"></span>`; }

    function renderList(){
      const q = ($('#search').value||'').toLowerCase();
      const f = $('#filterPass').value;
      const sort = $('#sortBy').value;
      let arr = [...state.entries];
      if(q){ arr = arr.filter(x=> [x.job,x.location,x.gc,x.super,x.notes,x.inspector,x.permit,x.completed,x.attention].join(' ').toLowerCase().includes(q)); }
      if(f){ if(f==='Pass') arr = arr.filter(x=> x.waterPass==='Pass'); if(f==='Fail') arr = arr.filter(x=> x.waterPass==='Fail'); if(f==='DPass') arr = arr.filter(x=> x.drainPass==='Pass'); if(f==='DFail') arr = arr.filter(x=> x.drainPass==='Fail'); }
      if(sort==='dateDesc') arr.sort((a,b)=> (b.date+b.time).localeCompare(a.date+a.time));
      if(sort==='dateAsc') arr.sort((a,b)=> (a.date+a.time).localeCompare(b.date+b.time));
      if(sort==='jobAZ') arr.sort((a,b)=> (a.job||'').localeCompare(b.job||''));
      if(sort==='jobZA') arr.sort((a,b)=> (b.job||'').localeCompare(a.job||''));
      const html = arr.map(x=>{
        const subtitle = [x.location, x.gc, x.super].filter(Boolean).join(' ‚Ä¢ ');
        const mats = (x.materials && x.materials.length) ? `${x.materials.length} material${x.materials.length>1?'s':''}` : '';
        const photos = (x.photos && x.photos.length) ? `${x.photos.length} photo${x.photos.length>1?'s':''}` : '';
        const extras = [mats, photos].filter(Boolean).join(' ‚Ä¢ ');
        return `<div class="item">
          <h3>${x.job || '(no job)'} <span class="muted" style="font-weight:500">‚Ä¢ ${x.date} ${x.time}</span></h3>
          <div class="chips">
            <span class="pill kpi">${statusDot(x.waterPass)} <span>Water: ${x.waterPass || 'N/A'}</span>${x.waterPSI?`<span class="muted"> @ ${x.waterPSI} PSI</span>`:''}</span>
            <span class="pill kpi">${statusDot(x.drainPass)} <span>Drain: ${x.drainPass || 'N/A'}</span>${x.drainHead?`<span class="muted"> ‚Ä¢ ${x.drainHead}</span>`:''}</span>
            ${x.testPulled==='Yes' ? `<span class="pill">Tag pulled</span>` : ''}
            ${extras?`<span class="pill">${extras}</span>`:''}
          </div>
          ${subtitle?`<div class="muted" style="margin:6px 0 8px 0">${subtitle}</div>`:''}
          ${x.completed?`<div style="margin:6px 0"><strong>Completed:</strong> <span class="muted">${escapeHTML(x.completed).slice(0,220)}</span></div>`:''}
          ${x.attention?`<div style="margin:6px 0"><strong>Needs Attention:</strong> <span class="muted">${escapeHTML(x.attention).slice(0,220)}</span></div>`:''}
          ${x.notes?`<div style="white-space:pre-wrap;border-left:3px solid var(--border);padding-left:10px">${escapeHTML(x.notes).slice(0,400)}</div>`:''}
          <div class="row" style="margin-top:8px;gap:8px;flex-wrap:wrap">
            <button type="button" data-act="edit" data-id="${x.id}">Edit</button>
            <button type="button" class="secondary" data-act="dup" data-id="${x.id}">Duplicate</button>
            <button type="button" class="secondary" data-act="share" data-id="${x.id}">Share</button>
            <button type="button" class="secondary" data-act="del" data-id="${x.id}">Delete</button>
          </div>
        </div>`;
      }).join('');
      $('#list').innerHTML = html || `<div class="muted">No entries yet. Save your first entry on the New/Edit tab.</div>`;
      $$('#list [data-act]').forEach(btn=> btn.addEventListener('click', async (e)=>{
        const id = e.currentTarget.dataset.id;
        const act = e.currentTarget.dataset.act;
        const entry = state.entries.find(x=> x.id===id);
        if(!entry) return;
        if(act==='edit'){
          document.querySelector('nav.tabs button[data-tab="form"]').click();
          resetForm(entry);
          $('#entryId').value = entry.id;
        }
        if(act==='dup'){
          const copy = JSON.parse(JSON.stringify(entry));
          copy.id = uid();
          copy.date = todayStr();
          copy.time = timeStr();
          copy.createdAt = new Date().toISOString();
          copy.updatedAt = copy.createdAt;
          state.entries.unshift(copy);
          await saveEntries(state.entries);
          renderList();
          toast('Duplicated.');
        }
        if(act==='del'){
          if(confirm('Delete this entry? This cannot be undone.')){
            const idx = state.entries.findIndex(x=> x.id===id);
            if(idx>=0){ state.entries.splice(idx,1); await saveEntries(state.entries); renderList(); toast('Deleted.'); }
          }
        }
        if(act==='share'){
          const txt = formatShare(entry);
          if(navigator.share){ navigator.share({ title: 'Plumbing Log', text: txt }).catch(()=>{}); }
          else { navigator.clipboard.writeText(txt).then(()=> toast('Copied to clipboard')); }
        }
      }));
    }

    function materialsToText(mats){ return (mats||[]).map(m=> `${m.qty||''} ${m.unit||''} ${m.name||''}`.trim()).join('; '); }

    function formatShare(e){
      const lines = [];
      lines.push(`Job: ${e.job}`);
      lines.push(`${e.date} ${e.time}`);
      if(e.location) lines.push(`Location: ${e.location}`);
      if(e.coords) lines.push(`GPS: ${e.coords.lat.toFixed(6)}, ${e.coords.lng.toFixed(6)}`);
      if(e.gc) lines.push(`GC: ${e.gc}`);
      if(e.super) lines.push(`Super: ${e.super}`);
      lines.push(`Water Test: ${e.waterTested} ‚Ä¢ ${e.waterPass}${e.waterPSI?` @ ${e.waterPSI} PSI`:''}${e.waterMinutes?` ‚Ä¢ ${e.waterMinutes} min`:''}`);
      lines.push(`Drain Test: ${e.drainTested} ‚Ä¢ ${e.drainPass}${e.drainHead?` ‚Ä¢ ${e.drainHead}`:''}${e.drainMinutes?` ‚Ä¢ ${e.drainMinutes} min`:''}`);
      lines.push(`Test Pulled: ${e.testPulled}${e.inspector?` ‚Ä¢ ${e.inspector}`:''}${e.permit?` ‚Ä¢ #${e.permit}`:''}`);
      if(e.completed) lines.push(`Completed: ${e.completed}`);
      if(e.attention) lines.push(`Needs Attention: ${e.attention}`);
      const mats = materialsToText(e.materials); if(mats) lines.push(`Materials: ${mats}`);
      if((e.photos||[]).length) lines.push(`Photos: ${(e.photos||[]).length} attached`);
      if(e.signature) lines.push(`Signature: attached`);
      if(e.nextSteps) lines.push(`Next: ${e.nextSteps}`);
      if(e.notes) lines.push(`Notes: ${e.notes}`);
      return lines.join('\n');
    }

    // Filters and search
    ['search','filterPass','sortBy'].forEach(id=> $('#'+id).addEventListener('input', renderList));

    // Export / Import
    function download(filename, text, type='application/json'){
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([text], {type:type}));
      a.download = filename;
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 3000);
    }
    function toCSV(){
      const cols = ['id','date','time','job','location','coords.lat','coords.lng','gc','super','waterTested','waterPass','waterPSI','waterMinutes','drainTested','drainPass','drainHead','drainMinutes','testPulled','inspector','permit','nextSteps','completed','attention','materials','photosCount','signature','notes','createdAt','updatedAt'];
      const rows = state.entries.map(e=>{
        const get = k => {
          if(k==='coords.lat') return e.coords? e.coords.lat : '';
          if(k==='coords.lng') return e.coords? e.coords.lng : '';
          if(k==='materials') return materialsToText(e.materials);
          if(k==='photosCount') return (e.photos||[]).length;
          if(k==='signature') return e.signature ? 'Yes' : '';
          return (e[k]!==undefined && e[k]!==null) ? String(e[k]).replace(/\n/g,'\\n') : '';
        };
        return cols.map(get).map(v=> `"${String(v).replace(/"/g,'""')}"`).join(',');
      });
      return [cols.join(','), ...rows].join('\n');
    }

    $('#btnExportJSON').addEventListener('click', ()=> download(`plumbing_log_${todayStr()}.json`, JSON.stringify(state.entries, null, 2)));
    $('#btnExportCSV').addEventListener('click', ()=>{
      const csv = toCSV();
      download(`plumbing_log_${todayStr()}.csv`, csv, 'text/csv');
    });

    // ---- File System Sync (Save/Load) ----
    // These functions use the File System Access API to write/read a JSON file.
    // This allows you to keep your log file in a cloud-synced folder (Google Drive,
    // Dropbox, OneDrive, etc.) so entries stay consistent across devices. The API
    // requires HTTPS or localhost and must be called in response to a user
    // gesture to show the file picker.
    async function saveToFile(){
      if(!window.showSaveFilePicker){
        alert('File System Access API is not supported in this browser.');
        return;
      }
      try{
        const options = {
          types: [ { description: 'JSON Files', accept: { 'application/json': ['.json'] } } ],
          suggestedName: 'plumbing_log.json'
        };
        const handle = await window.showSaveFilePicker(options);
        const writable = await handle.createWritable();
        await writable.write(JSON.stringify(state.entries, null, 2));
        await writable.close();
        toast('Entries saved to file.');
      }catch(err){
        if(err.name !== 'AbortError') alert('Save failed: ' + err.message);
      }
    }

    async function loadFromFile(){
      if(!window.showOpenFilePicker){
        alert('File System Access API is not supported in this browser.');
        return;
      }
      try{
        const [handle] = await window.showOpenFilePicker({
          types: [ { description: 'JSON Files', accept: { 'application/json': ['.json'] } } ]
        });
        const file = await handle.getFile();
        const text = await file.text();
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('File does not contain an array');
        arr.forEach(x=>{
          x.id = uid();
          x.createdAt = new Date().toISOString();
          x.updatedAt = x.createdAt;
        });
        state.entries = [...arr, ...state.entries];
        await saveEntries(state.entries);
        renderList();
        toast(`Loaded ${arr.length} entries from file.`);
      }catch(err){
        if(err.name !== 'AbortError') alert('Load failed: ' + err.message);
      }
    }

    // Attach sync functions to buttons
    $('#btnSaveToFile').addEventListener('click', saveToFile);
    $('#btnLoadFromFile').addEventListener('click', loadFromFile);

    $('#fileInput').addEventListener('change', async (e)=>{
      const file = e.target.files[0];
      if(!file) return;
      const text = await file.text();
      try{
        const arr = JSON.parse(text);
        if(!Array.isArray(arr)) throw new Error('Invalid file');
        arr.forEach(x=>{ x.id = uid(); x.createdAt = new Date().toISOString(); x.updatedAt = x.createdAt; });
        state.entries = [...arr, ...state.entries];
        await saveEntries(state.entries);
        toast(`Imported ${arr.length} entries.`);
      }catch(err){ alert('Import failed: ' + err.message); }
      e.target.value = '';
      renderList();
    });

    // Settings
    $('#btnSaveSettings').addEventListener('click', async ()=>{
      state.settings = {
        defGC: $('#defGC').value.trim(),
        defPSI: $('#defPSI').value ? Number($('#defPSI').value) : '',
        defCity: $('#defCity').value.trim(),
        defSuper: $('#defSuper').value.trim(),
        geoProvider: $('#geoProvider').value,
        geoApiKey: $('#geoApiKey').value.trim(),
        contactEmail: $('#contactEmail').value.trim(),
        addrFormat: $('#addrFormat').value,
        theme: document.documentElement.dataset.theme
      };
      await saveSettings(state.settings);
      toast('Settings saved');
    });

    $('#btnClearAll').addEventListener('click', async ()=>{
      if(confirm('Delete ALL entries? This cannot be undone.')){
        state.entries = []; await saveEntries(state.entries); renderList(); toast('All entries cleared.');
      }
    });

    // Toast helper
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.position='fixed'; t.style.bottom='16px'; t.style.left='50%'; t.style.transform='translateX(-50%)'; t.style.background='var(--panel)'; t.style.border='1px solid var(--border)'; t.style.padding='10px 14px'; t.style.borderRadius='999px'; t.style.boxShadow='0 10px 30px var(--shadow)'; t.style.zIndex='50';
      document.body.appendChild(t);
      setTimeout(()=> t.remove(), 2000);
    }

    // Init
    (async function init(){
      state.entries = await loadEntries();
      state.settings = await loadSettings();
      applyThemeFromSettings();
      resetForm({});
      renderList();
      initSignature();
    })();
  </script>
</body>
</html>

